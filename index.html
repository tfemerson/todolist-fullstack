<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- è§†å£è®¾ç½®ï¼šç¡®ä¿ç§»åŠ¨ç«¯æ­£ç¡®æ˜¾ç¤º -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- é¡µé¢æ ‡é¢˜ -->
    <title>æ™ºèƒ½å¾…åŠäº‹é¡¹æ¸…å•</title>
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- ä¸»é¢˜é¢œè‰²ï¼šçŠ¶æ€æ é¢œè‰² -->
    <meta name="theme-color" content="#667eea">
    
    <!-- iOS Safari ç‰¹æ®Šé…ç½® -->
    <!-- ä½¿ç”¨æ–°çš„ mobile-web-app-capable æ›¿ä»£å·²å¼ƒç”¨çš„ apple-mobile-web-app-capable -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¾…åŠæ¸…å•">
    
    <!-- iOS å›¾æ ‡ï¼ˆSafariä¸è¯»å–manifestï¼Œéœ€è¦å•ç‹¬é…ç½®ï¼‰ -->
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- ç½‘ç«™å›¾æ ‡ -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icon-192.png">
    
    <!-- SEO æè¿° -->
    <meta name="description" content="æ™ºèƒ½å¾…åŠæ¸…å• - é«˜æ•ˆç®¡ç†æ‚¨çš„æ¯æ—¥ä»»åŠ¡ï¼Œè®©ç”Ÿæ´»æ›´æœ‰æ¡ç†">
    
    <!-- ç¦æ­¢è‡ªåŠ¨æ£€æµ‹ç”µè¯å·ç ï¼ˆé˜²æ­¢è¯¯è¯†åˆ«ï¼‰ -->
    <meta name="format-detection" content="telephone=no">
    
    <!-- é¢„è¿æ¥åˆ°APIæœåŠ¡å™¨ï¼ˆåŠ é€Ÿé¦–æ¬¡è¯·æ±‚ï¼‰ -->
    <link rel="preconnect" href="https://task.tudou168.com">
</head>
<body>
    <!-- åº”ç”¨æ ¹èŠ‚ç‚¹ -->
    <div id="root"></div>
    
    <!-- ä¸»åº”ç”¨è„šæœ¬ -->
    <script type="module" src="/src/index.tsx"></script>
    
    <!-- Service Worker æ³¨å†Œè„šæœ¬ -->
    <script>
        // ============================================
        // Service Worker æ³¨å†Œå’Œç®¡ç†
        // ============================================
        
        // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ Service Worker
        if ('serviceWorker' in navigator) {
            // é¡µé¢åŠ è½½å®Œæˆåæ³¨å†Œ Service Worker
            window.addEventListener('load', async () => {
                try {
                    // æ³¨å†Œ Service Worker
                    const registration = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/'
                    });
                    
                    console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('ğŸ”„ å‘ç°æ–°ç‰ˆæœ¬ Service Worker');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œæç¤ºç”¨æˆ·åˆ·æ–°
                                if (confirm('å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ')) {
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                    window.location.reload();
                                }
                            }
                        });
                    });
                    
                } catch (error) {
                    console.error('âŒ Service Worker æ³¨å†Œå¤±è´¥:', error);
                }
            });
            
            // ç›‘å¬ Service Worker æ§åˆ¶æƒå˜åŒ–
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('ğŸ”„ Service Worker å·²æ›´æ–°ï¼Œé¡µé¢å°†åˆ·æ–°');
            });
        } else {
            console.log('âš ï¸ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Service Worker');
        }
        
        // ============================================
        // PWA å®‰è£…æç¤ºå¤„ç†
        // ============================================
        
        // å­˜å‚¨å®‰è£…æç¤ºäº‹ä»¶
        let deferredPrompt = null;
        
        // ç›‘å¬ beforeinstallprompt äº‹ä»¶
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('ğŸ“± PWA å¯ä»¥å®‰è£…');
            // é˜»æ­¢é»˜è®¤çš„å®‰è£…æç¤º
            e.preventDefault();
            // ä¿å­˜äº‹ä»¶ï¼Œç¨åä½¿ç”¨
            deferredPrompt = e;
            
            // ä½ å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºè‡ªå®šä¹‰çš„å®‰è£…æŒ‰é’®
            // showInstallButton();
        });
        
        // ç›‘å¬å®‰è£…æˆåŠŸäº‹ä»¶
        window.addEventListener('appinstalled', () => {
            console.log('âœ… PWA å®‰è£…æˆåŠŸï¼');
            deferredPrompt = null;
        });
        
        // æä¾›ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼Œç”¨äºè§¦å‘å®‰è£…
        window.installPWA = async () => {
            if (deferredPrompt) {
                // æ˜¾ç¤ºå®‰è£…æç¤º
                deferredPrompt.prompt();
                // ç­‰å¾…ç”¨æˆ·å“åº”
                const { outcome } = await deferredPrompt.userChoice;
                console.log('ç”¨æˆ·é€‰æ‹©:', outcome);
                deferredPrompt = null;
            } else {
                alert('å½“å‰æ— æ³•å®‰è£…ï¼Œè¯·ä½¿ç”¨æµè§ˆå™¨èœå•ä¸­çš„"æ·»åŠ åˆ°ä¸»å±å¹•"é€‰é¡¹');
            }
        };
        
        // ============================================
        // ç½‘ç»œçŠ¶æ€ç›‘å¬
        // ============================================
        
        window.addEventListener('online', () => {
            console.log('ğŸŒ ç½‘ç»œå·²è¿æ¥');
            document.body.classList.remove('offline');
        });
        
        window.addEventListener('offline', () => {
            console.log('ğŸ“´ ç½‘ç»œå·²æ–­å¼€');
            document.body.classList.add('offline');
        });
    </script>
</body>
</html>